{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://juridico-cli.local/schemas/decisao_processo.consolidated.schema.json",
  "title": "decisao_processo — v2 (consolidated N:1)",
  "description": "Consolidação N:1 de decisões (decisao_processo) para o mesmo caso/lote. Preserva itens literais e une âncoras; registra conflitos.",
  "type": "object",
  "required": ["document_type", "mode", "sources", "merge_meta", "conflicts"],
  "properties": {
    "document_type": { "const": "decisao_processo" },
    "mode": { "const": "consolidated" },

    "case_id": {
      "$ref": "defs/common.schema.json#/$defs/NonEmptyString",
      "description": "Identificador lógico do lote/caso no pipeline."
    },

    "process_number": { "$ref": "#/$defs/AnchoredString" },

    "sources": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/SourceRefInput" },
      "description": "Fontes 1:1 usadas na consolidação."
    },

    "merge_meta": { "$ref": "#/$defs/MergeMeta" },

    "conflicts": {
      "type": "array",
      "items": { "$ref": "defs/common.schema.json#/$defs/ConflictRecord" },
      "description": "Conflitos detectados (pode ser vazio)."
    },

    "decision_type": { "$ref": "#/$defs/AnchoredDecisionType" },

    "decision_date": { "$ref": "#/$defs/AnchoredDate" },

    "decisor": { "$ref": "#/$defs/Decisor" },

    "relatorio": {
      "type": "array",
      "items": { "$ref": "#/$defs/AnchoredTextItem" }
    },

    "fundamentacao": {
      "type": "array",
      "items": { "$ref": "#/$defs/AnchoredTextItem" }
    },

    "dispositivo": {
      "type": "array",
      "items": { "$ref": "#/$defs/DispositivoItem" },
      "description": "Dispositivo (itens literais). Deve ser o foco de ancoragem."
    },

    "outcome": { "$ref": "#/$defs/Outcome" },

    "determinacoes": {
      "type": "array",
      "items": { "$ref": "#/$defs/AnchoredTextItem" }
    },

    "anchors": {
      "type": "array",
      "items": { "$ref": "#/$defs/Anchor" }
    }
  },

  "anyOf": [
    { "required": ["case_id"] },
    { "required": ["process_number"] },
    { "required": ["dispositivo"] },
    { "required": ["outcome"] }
  ],

  "unevaluatedProperties": false,

  "$defs": {
    "Anchor": { "$ref": "defs/common.schema.json#/$defs/Anchor" },

    "SourceRefInput": {
      "allOf": [
        { "$ref": "defs/common.schema.json#/$defs/SourceRef" },
        {
          "properties": {
            "document_type": { "const": "decisao_processo" }
          }
        }
      ],
      "unevaluatedProperties": false
    },

    "MergeMeta": {
      "type": "object",
      "required": ["merge_strategy", "merged_at", "input_count"],
      "properties": {
        "merge_strategy": { "const": "llm_merge_assisted_v1" },
        "merged_at": { "$ref": "defs/common.schema.json#/$defs/ISODateTime" },
        "input_count": { "type": "integer", "minimum": 0 },
        "ignored_inputs": {
          "type": "array",
          "items": { "$ref": "#/$defs/IgnoredInput" }
        }
      },
      "unevaluatedProperties": false
    },

    "IgnoredInput": {
      "type": "object",
      "required": ["reason"],
      "properties": {
        "source_id": { "$ref": "defs/common.schema.json#/$defs/UUID" },
        "md_filename": { "$ref": "defs/common.schema.json#/$defs/NonEmptyString" },
        "reason": { "$ref": "defs/common.schema.json#/$defs/NonEmptyString" }
      },
      "unevaluatedProperties": false
    },

    "AnchoredString": {
      "type": "object",
      "required": ["value", "anchors"],
      "properties": {
        "value": { "$ref": "defs/common.schema.json#/$defs/NonEmptyString" },
        "anchors": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Anchor" }
        }
      },
      "unevaluatedProperties": false
    },

    "AnchoredDate": {
      "type": "object",
      "required": ["value", "anchors"],
      "properties": {
        "value": { "$ref": "defs/common.schema.json#/$defs/ISODate" },
        "anchors": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Anchor" }
        }
      },
      "unevaluatedProperties": false
    },

    "AnchoredTextItem": {
      "type": "object",
      "required": ["text", "anchors"],
      "properties": {
        "text": { "type": "string", "minLength": 1, "maxLength": 7000 },
        "label": { "$ref": "defs/common.schema.json#/$defs/NonEmptyString" },
        "anchors": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Anchor" }
        }
      },
      "unevaluatedProperties": false
    },

    "AnchoredDecisionType": {
      "type": "object",
      "required": ["value", "anchors"],
      "properties": {
        "value": {
          "type": "string",
          "enum": ["decisao", "sentenca", "acordao", "despacho", "outro"]
        },
        "value_raw": { "$ref": "defs/common.schema.json#/$defs/NonEmptyString" },
        "anchors": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Anchor" }
        }
      },
      "unevaluatedProperties": false
    },

    "Decisor": {
      "type": "object",
      "required": ["anchors"],
      "properties": {
        "name": { "$ref": "defs/common.schema.json#/$defs/NonEmptyString" },
        "role": { "$ref": "defs/common.schema.json#/$defs/NonEmptyString" },
        "orgao_julgador": { "$ref": "defs/common.schema.json#/$defs/NonEmptyString" },
        "tribunal": { "$ref": "defs/common.schema.json#/$defs/NonEmptyString" },
        "anchors": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Anchor" }
        }
      },
      "anyOf": [
        { "required": ["name"] },
        { "required": ["orgao_julgador"] },
        { "required": ["tribunal"] }
      ],
      "unevaluatedProperties": false
    },

    "DispositivoItem": {
      "type": "object",
      "required": ["text", "anchors"],
      "properties": {
        "text": { "type": "string", "minLength": 1, "maxLength": 6000 },
        "label": { "$ref": "defs/common.schema.json#/$defs/NonEmptyString" },
        "anchors": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Anchor" }
        }
      },
      "unevaluatedProperties": false
    },

    "Outcome": {
      "type": "object",
      "required": ["value", "anchors"],
      "properties": {
        "value": { "$ref": "defs/common.schema.json#/$defs/DecisionOutcome" },
        "value_raw": { "$ref": "defs/common.schema.json#/$defs/NonEmptyString" },
        "anchors": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Anchor" }
        }
      },
      "unevaluatedProperties": false
    }
  }
}
