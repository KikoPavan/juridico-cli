{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/collector-cad-obr.io.schema.json",
  "title": "Contrato de I/O do agente collector-cad-obr",
  "description": "Schema para padronizar a requisição/opções de execução e o relatório de execução do collector-cad-obr. A saída estruturada POR DOCUMENTO é definida pelos schemas específicos referenciados em config.yaml (schemas/escritura_imovel.schema.json, schemas/contrato_social.schema.json, schemas/escritura_hipotecaria.schema.json).",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "agent": {
      "type": "string",
      "const": "collector-cad-obr",
      "description": "Identificador do agente."
    },
    "io_version": {
      "type": "string",
      "description": "Versão lógica do contrato de I/O (não confundir com version das skills).",
      "default": "collector-cad-obr-io-v1"
    },
    "inputs": {
      "type": "object",
      "additionalProperties": false,
      "description": "Parâmetros/overrides opcionais para execução do collector (o agente pode ignorar campos que não implemente).",
      "properties": {
        "config_path": {
          "type": "string",
          "description": "Caminho do config.yaml do collector-cad-obr.",
          "default": "agents/collector-cad-obr/config.yaml"
        },
        "jobs": {
          "type": [
            "array",
            "null"
          ],
          "description": "Lista de job.id a executar. Se null/ausente, executa todos do config.yaml.",
          "items": {
            "type": "string"
          }
        },
        "overrides": {
          "type": [
            "object",
            "null"
          ],
          "additionalProperties": false,
          "description": "Overrides opcionais (globais) para caminhos e execução.",
          "properties": {
            "input_dir": {
              "type": [
                "string",
                "null"
              ],
              "description": "Sobrescreve o input_dir de TODOS os jobs (uso pontual para testes)."
            },
            "output_dir": {
              "type": [
                "string",
                "null"
              ],
              "description": "Sobrescreve o output_dir de TODOS os jobs (uso pontual para testes)."
            },
            "mode": {
              "type": [
                "string",
                "null"
              ],
              "enum": [
                "individual",
                null
              ],
              "description": "Modo de processamento (neste projeto: 'individual' = 1 JSON por .md)."
            },
            "max_files": {
              "type": [
                "integer",
                "null"
              ],
              "minimum": 1,
              "description": "Limite máximo de arquivos .md a processar por job (debug)."
            },
            "dry_run": {
              "type": [
                "boolean",
                "null"
              ],
              "description": "Se true, não grava saída; apenas valida leitura/roteamento (quando implementado)."
            }
          }
        },
        "context": {
          "type": [
            "object",
            "null"
          ],
          "additionalProperties": false,
          "description": "Arquivos de contexto opcionais (não são documentos processados pelo collector).",
          "properties": {
            "context_file": {
              "type": [
                "string",
                "null"
              ],
              "description": "Ex.: data/context.json"
            },
            "relacoes_file": {
              "type": [
                "string",
                "null"
              ],
              "description": "Ex.: data/contexto_relacoes.json"
            }
          }
        }
      }
    },
    "outputs": {
      "type": "object",
      "additionalProperties": false,
      "description": "Relatório de execução do collector.",
      "properties": {
        "run_id": {
          "type": [
            "string",
            "null"
          ],
          "description": "Identificador da execução (UUID), se gerado."
        },
        "started_at": {
          "type": [
            "string",
            "null"
          ],
          "format": "date-time",
          "description": "Timestamp ISO-8601 do início."
        },
        "finished_at": {
          "type": [
            "string",
            "null"
          ],
          "format": "date-time",
          "description": "Timestamp ISO-8601 do fim."
        },
        "jobs": {
          "type": "array",
          "description": "Resultado por job executado.",
          "items": {
            "$ref": "#/$defs/JobRun"
          }
        },
        "summary": {
          "type": [
            "object",
            "null"
          ],
          "additionalProperties": false,
          "description": "Resumo agregado.",
          "properties": {
            "jobs_run": {
              "type": "integer",
              "minimum": 0
            },
            "files_total": {
              "type": "integer",
              "minimum": 0
            },
            "files_ok": {
              "type": "integer",
              "minimum": 0
            },
            "files_failed": {
              "type": "integer",
              "minimum": 0
            },
            "outputs_written": {
              "type": "integer",
              "minimum": 0
            }
          }
        }
      },
      "required": [
        "jobs"
      ]
    },
    "logs": {
      "type": [
        "object",
        "null"
      ],
      "additionalProperties": false,
      "description": "Informações de log/telemetria (quando aplicável).",
      "properties": {
        "log_file": {
          "type": [
            "string",
            "null"
          ]
        },
        "warnings": {
          "type": [
            "array",
            "null"
          ],
          "items": {
            "type": "string"
          }
        },
        "errors": {
          "type": [
            "array",
            "null"
          ],
          "items": {
            "type": "string"
          }
        }
      }
    }
  },
  "required": [
    "agent",
    "inputs",
    "outputs"
  ],
  "$defs": {
    "JobRun": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "job_id": {
          "type": [
            "string",
            "null"
          ]
        },
        "job_name": {
          "type": [
            "string",
            "null"
          ]
        },
        "skill_key": {
          "type": [
            "string",
            "null"
          ],
          "enum": [
            "escritura_imovel",
            "contrato_social",
            "escritura_hipotecaria",
            null
          ],
          "description": "Skill aplicada no job."
        },
        "schema_file": {
          "type": [
            "string",
            "null"
          ]
        },
        "input_dir": {
          "type": [
            "string",
            "null"
          ]
        },
        "output_dir": {
          "type": [
            "string",
            "null"
          ]
        },
        "mode": {
          "type": [
            "string",
            "null"
          ],
          "enum": [
            "individual",
            null
          ]
        },
        "files": {
          "type": "array",
          "description": "Resultado por arquivo .md.",
          "items": {
            "$ref": "#/$defs/FileRun"
          }
        }
      },
      "required": [
        "files"
      ]
    },
    "FileRun": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "input_md": {
          "type": "string"
        },
        "output_json": {
          "type": [
            "string",
            "null"
          ]
        },
        "status": {
          "type": "string",
          "enum": [
            "ok",
            "skipped",
            "error"
          ]
        },
        "front_matter_valid": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "error_message": {
          "type": [
            "string",
            "null"
          ]
        }
      },
      "required": [
        "input_md",
        "status"
      ]
    }
  }
}